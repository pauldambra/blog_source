I" <aside class="series">
  <h1>
    This post is part of a series on improving this blog #recursion
  </h1>
  <div class="links">
    <div class="previous">
      <a href="/structured-data-with-jekyll.html">Previous Post</a>
    </div>
    <div class="next">
      <a href="/2017/generating-static-amp.html">Next Post</a>
    </div>
  </div>
</aside>

<p>One of the benefits of generating a site as a static artefact (here using <a href="https://jekyllrb.com/">Jekyll</a> but there are a gazillion tools) is that the finished product is a known quantity. Anything that's a known quantity can be tested!</p>

<!--more-->

<h1 id="test-the-generated-html">Test the generated HTML</h1>

<p>I chose a wonderful tool called <a href="https://github.com/gjtorikian/html-proofer">htmlproofer</a> which, since it has a CLI, can be invoked as part of the build.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#! /bin/bash

set -eu

bundle exec htmlproofer \
  _site \
  --file-ignore /amp/,/.git/ \
  --check-favicon \
  --check-html \
  --check-opengraph
</code></pre></div></div>

<p>This checks the generated site directory. Ignoring the AMP folder. The list of checks this carries out (reproduced here from <a href="https://github.com/gjtorikian/html-proofer/blob/c95d21dd5221243c7a7cfb1218fd6fd853381765/README.md">the project readme</a>):</p>

<hr />

<h3 id="images">Images</h3>

<p>img elements:</p>

<ul>
  <li>Whether all your images have alt tags</li>
  <li>Whether your internal image references are not broken</li>
  <li>Whether external images are showing</li>
  <li>Whether your images are HTTP</li>
</ul>

<h3 id="links">Links</h3>

<p>a, link elements:</p>

<ul>
  <li>Whether your internal links are working</li>
  <li>Whether your internal hash references (#linkToMe) are working</li>
  <li>Whether external links are working</li>
  <li>Whether your links are HTTPS</li>
  <li>Whether CORS/SRI is enabled</li>
</ul>

<h3 id="scripts">Scripts</h3>

<p>script elements:</p>

<ul>
  <li>Whether your internal script references are working</li>
  <li>Whether external scripts are loading</li>
  <li>Whether CORS/SRI is enabled</li>
</ul>

<h3 id="favicon">Favicon</h3>

<ul>
  <li>Whether your favicons are valid.</li>
</ul>

<h3 id="opengraph">OpenGraph</h3>

<p>Whether the images and URLs in the OpenGraph metadata are valid.
HTML</p>

<p>Whether your HTML markup is valid. This is done via Nokogiri, to ensure well-formed markup.</p>

<hr />
<!--alex ignore invalid --->
<p>If the following invalid elements are added to the page and the htmlproofer script run…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;img src="foo.png"/&gt;

&lt;a href="/does-not-exist"&gt;invalid link&lt;/a&gt;
</code></pre></div></div>

<p>…then the output highlights five errors.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running ["HtmlCheck", "FaviconCheck", "ImageCheck", "LinkCheck", "ScriptCheck", "OpenGraphCheck"] on ["_site"] on *.html... 
Checking 310 external links...
Ran on 55 files!
- _site/2017/testing-static-sites.html
  *  External link http://pauldambra.github.io/2017/testing-static-sites.html failed: 404 No error
  *  External link http://pauldambra.github.io/amp/2017/testing-static-html failed: 404 No error
  *  image foo.png does not have an alt attribute (line 678)
  *  internal image foo.png does not exist (line 678)
  *  internally linking to /does-not-exist, which does not exist (line 680)
     &lt;a href="/does-not-exist"&gt;invalid link&lt;/a&gt;
htmlproofer 3.5.0 | Error:  HTML-Proofer found 5 failures!
The command "./htmltest.sh" exited with 1.
</code></pre></div></div>

<p>Three of these were expected:</p>

<ul>
  <li>that the image element doesn't have an alt attribute</li>
  <li>that foo.png does not exist</li>
  <li>and that the internal link to <code class="language-plaintext highlighter-rouge">/does-not-exist</code> does not, erm, exist</li>
</ul>

<h2 id="ruh-roh">ruh roh</h2>

<p>Interestingly this also reveals a bug in the setup.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  *  External link http://pauldambra.github.io/2017/testing-static-sites.html failed: 404 No error
  *  External link http://pauldambra.github.io/amp/2017/testing-static-html failed: 404 No errors
</code></pre></div></div>

<p>Grepping the generated html for those two external links finds them in the HEAD of the document.</p>

<p>I'd only run this process on existing, <em>published</em> blog posts since adding it. This is the first time that it has run against a repo with a new, <em>unpublished</em> blog post and it's correctly highlighting that the open graph URL for this article and the amphtml link rel for this article don't exist. Because they don't - this article hasn't been published yet.</p>

<p>The site's .travis.yml file currently has:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script:
  - "./build.sh"
  - "./htmltest.sh"
  - "./amp-validate.sh"
after_success:
  - "./deploy.sh"
</code></pre></div></div>

<p>this will have to become</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script:
  - "./build.sh"
  - "./amp-validate.sh"
after_success:
  - "./deploy.sh"
  - "./htmltest.sh"
</code></pre></div></div>

<p>so that the HTML test only runs after the deploy has occurred. Ideally any published documents would be tested before deploy and could fail the build and newly published documents only after their first deploy as a smoke test. But this will do for now.</p>

<h1 id="test-the-generated-amp">Test the generated AMP</h1>

<p>An AMP version of the site is generated at build time too. HTML-Proofer can't test the AMP site so these pages could be broken and that test doesn't protect us.</p>

<p>AMP is a dream to work with because the AMP debugger is well built and provides clear, actionable errors. Brilliantly that online debugger is available as an NPM package so as can be seen above there is an <code class="language-plaintext highlighter-rouge">amp-validate.sh</code> as part of the build.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#! /bin/bash

set -eu

npm install -g amphtml-validator

for f in `find _site/amp -type f -name '*.html'`; do
  amphtml-validator $f
done
</code></pre></div></div>

<p>Because the AMP debugger was so helpful when adding AMP generation the only warning this generated when it was added to build was many instances of</p>

<blockquote>
  <p>_site/amp/2009/05/anonymous-methods-when-invoking-in-vb/index.html:633:6 The extension 'amp-twitter extension .js script' was &gt; found on this page, but is unused (no 'amp-twitter' tag seen). This may become an error in the future. (see https://www.ampproject.org/docs/reference/extended/amp-twitter.html)</p>
</blockquote>

<p>Each AMP page had the amp-twitter extension included whether or not there was a tweet embedded in the page. <a href="https://github.com/pauldambra/blog_source/commit/4329b333aa15c3e71827ba0a5c42e608616d881a">This was fixed.</a></p>

<p>And a single, old page which the AMP generator couldn't handle and so</p>

<blockquote>
  <p>_site/amp/2011/04/ssh-without-password/index.html:636:3 The attribute 'style' may not appear in tag 'span'.
_site/amp/2011/04/ssh-without-password/index.html:667:15 The tag 'paste' is disallowed.</p>
</blockquote>

<p><a href="https://github.com/pauldambra/blog_source/commit/c82542fec278d97c2749f6c09961efae15df175c#diff-b584697099c805190a2a5cfaae07bfc1">Again fixed by updating the HTML of the non-AMP post.</a></p>

<h1 id="and-so">And so?</h1>

<p>When these two types of test were added there were 237 HTML errors and 9 AMP warnings and 2 AMP errors. From as little as missing a favicon through to genuinely malformed pages. Adding these tests was straight-forward, added value to the CI for this blog, and is another good indication of the benefits of statically generated sites.</p>
:ET