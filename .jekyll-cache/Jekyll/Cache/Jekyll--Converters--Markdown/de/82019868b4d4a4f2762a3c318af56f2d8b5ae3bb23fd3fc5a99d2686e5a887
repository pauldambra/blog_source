I"&j<p><a href="/2018/02/serverless-1.html">Part One</a> - describing event-driven and serverless systems</p>

<p><a href="/2018/02/serverless-2.html">Part Two</a> - Infrastructure as code walking skeleton</p>

<p>In this post we will look at how SAM local let's you develop locally and write the first lambda function. To take a <code class="language-plaintext highlighter-rouge">ProposeDestination</code> command and write a <code class="language-plaintext highlighter-rouge">DestinationProposed</code> event to the eventstream.</p>

<p>"<a href="https://github.com/awslabs/aws-sam-local/blob/28eacbdd299917b2cceeb9444fe22bd57d33d97d/README.md">SAM Local</a> can be used to test functions locally, start a local API Gateway from a SAM template, validate a SAM template, and generate sample payloads for various event sources."</p>

<!--more-->

<h1 id="sam-local">SAM Local</h1>

<p>You have to have Docker running locally and then you can <code class="language-plaintext highlighter-rouge">npm install -g aws-sam-local</code>.</p>

<p>To start the API Gateway and Lambda example from <a href="/2018/02/serverless-2.html">part two</a> navigate to the directory containing the template.yaml file and run <code class="language-plaintext highlighter-rouge">sam local start-api</code></p>

<p>This starts lambda in Docker and shows what endpoints are mounted:</p>

<p><img src="/images/events/start-api.png" alt="the start-api command console output" /></p>

<p>You can then POST to the endpoint <code class="language-plaintext highlighter-rouge">curl -H "Content-Type: application/json" -X POST -d '{"geolocation":"xyz", "name":"test"}' http://127.0.0.1:3000/destination</code></p>

<p>Which outputs the same information as you would see in cloudwatch logs:</p>

<p><img src="/images/events/api-console-output.png" alt="the api console output" /></p>

<h1 id="dynamodb">DynamoDB</h1>

<p>This took several attempts to get running - mostly because of unfamiliarity with Docker - <a href="https://twitter.com/heitor_lessa/status/968574144681037826">AWS were super helpful on twitter</a> despite my silliness. Without that confusion this would have been very straightforward.</p>

<p>There are three steps to this:</p>

<h2 id="1-start-dynamodb">1) Start dynamodb</h2>

<p>DynamoDB needs to be run as a named container and on the same Docker network as SAM local</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker network create lambda-local
sam <span class="nb">local </span>start-api <span class="nt">--docker-network</span> lambda-local
docker run <span class="nt">-d</span> <span class="nt">-v</span> <span class="s2">"</span><span class="nv">$PWD</span><span class="s2">"</span>:/dynamodb_local_db <span class="nt">-p</span> 8000:8000 <span class="nt">--network</span> lambda-local <span class="nt">--name</span> dynamodb cnadiminti/dynamodb-local
</code></pre></div></div>

<h2 id="2-create-the-dynamodb-table">2) Create the DynamoDB table</h2>

<p>SAM local can't create DynamoDB tables from the template.yaml in the way that CloudFormation will when the SAM application is deployed so the table needs manually creating.</p>

<p>The following AWS CLI command will create the table as defined in the template.yaml:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws dynamodb create-table <span class="se">\</span>
  <span class="nt">--table-name</span> visitplannr-events <span class="se">\</span>
  <span class="nt">--attribute-definitions</span> <span class="se">\</span>
        <span class="nv">AttributeName</span><span class="o">=</span>EventId,AttributeType<span class="o">=</span>S <span class="nv">AttributeName</span><span class="o">=</span>StreamName,AttributeType<span class="o">=</span>S <span class="se">\</span>
  <span class="nt">--key-schema</span> <span class="nv">AttributeName</span><span class="o">=</span>StreamName,KeyType<span class="o">=</span>HASH <span class="nv">AttributeName</span><span class="o">=</span>EventId,KeyType<span class="o">=</span>RANGE <span class="se">\</span>
  <span class="nt">--provisioned-throughput</span> <span class="se">\</span>
  <span class="nv">ReadCapacityUnits</span><span class="o">=</span>5,WriteCapacityUnits<span class="o">=</span>5 <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://0.0.0.0:8000
</code></pre></div></div>

<h2 id="3-write-some-code-to-have-the-one-talk-to-the-other">3) Write some code to have the one talk to the other</h2>

<p>The client connection code is:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">aws-sdk</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">awsRegion</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_REGION</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">eu-west-2</span><span class="dl">'</span>

<span class="kd">let</span> <span class="nx">dynamoDbClient</span>
<span class="kd">const</span> <span class="nx">makeClient</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">region</span><span class="p">:</span> <span class="nx">awsRegion</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SAM_LOCAL</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">endpoint</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://dynamodb:8000</span><span class="dl">'</span>
  <span class="p">}</span>
  <span class="nx">dynamoDbClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">DynamoDB</span><span class="p">.</span><span class="nx">DocumentClient</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">dynamoDbClient</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">connect</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">dynamoDbClient</span> <span class="o">||</span> <span class="nx">makeClient</span><span class="p">()</span>
<span class="p">}</span>

</code></pre></div></div>

<p>This module exposes a connect method that lazily initializes the db client.</p>

<p>SAM local sets an AWS_SAM_LOCAL environment variable so the code checks for that and if it is present sets the endpoint URL to <code class="language-plaintext highlighter-rouge">http://dynamodb:8000</code>. This is the container name and the port it exposes.</p>

<p>For the production code you don't need to set any endpoint and can let lambda figure out what to connect to.</p>

<h1 id="the-propose-destination-handler">The propose destination handler</h1>

<p>The handler should act as a <a href="http://blog.ploeh.dk/2011/07/28/CompositionRoot/">composition root</a>. It creates the application's object graph and lets the parts do the work. This allows unit tests to inject fakes. If those tests were to exercise the handler directly the code would run the <code class="language-plaintext highlighter-rouge">dynamoDbClient</code> and timeout waiting for dynamodb.</p>

<p>The handler ends up looking like this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">httpResponse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./destinations/httpResponse</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">mapCommand</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./destinations/mapCommand</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">guid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./GUID</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">streamRepo</span>
<span class="kd">const</span> <span class="nx">dynamoDbClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./destinations/dynamoDbClient</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">makeStreamRepository</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./destinations/make-stream-repository</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">commandHandler</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./destinations/commandHandler</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">proposeDestination</span> <span class="o">=</span> <span class="nx">mapCommand</span><span class="p">.</span><span class="nx">fromAPI</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="dl">'</span><span class="s1">proposeDestination</span><span class="dl">'</span><span class="p">)</span>

  <span class="nx">streamRepo</span> <span class="o">=</span> <span class="nx">streamRepo</span> <span class="o">||</span> <span class="nx">makeStreamRepository</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="nx">dynamoDbClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(),</span> <span class="nx">guid</span><span class="p">)</span>

  <span class="nx">commandHandler</span>
    <span class="p">.</span><span class="nx">apply</span><span class="p">({</span>
      <span class="na">command</span><span class="p">:</span> <span class="nx">proposeDestination</span><span class="p">,</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">destinationProposed</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">streamName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">destination</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">streamRepository</span><span class="p">:</span> <span class="nx">streamRepo</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">proposeDestination</span><span class="p">,</span> <span class="nx">callback</span><span class="p">))</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">invalid</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">proposeDestination</span><span class="p">,</span> <span class="nx">callback</span><span class="p">))</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Here the handler converts the API gateway event to a <code class="language-plaintext highlighter-rouge">ProposeDestination</code> command. It then either uses the existing stream repository or creates one currying the dynamodb client and guid generator.
<!--alex ignore invalid --->
The command handler is then called. It either converts the command to a <code class="language-plaintext highlighter-rouge">destinationProposed</code> event and returns an HTTP 200 success. Or fails and returns an HTTP 400 invalid request.</p>

<h1 id="testing-this-with-sam-local">Testing this with SAM local</h1>

<p>I haven't wrapped this up into something useful that could be run in a CI pipeline but as a sense check before deployment this is a good starting point.</p>

<p>First ensure SAM local is running:</p>

<p><code class="language-plaintext highlighter-rouge">AWS_REGION=eu-west-2 sam local start-api --docker-network lambda-local</code></p>

<p>Then also that dynamodb is running:</p>

<p><code class="language-plaintext highlighter-rouge">docker run -d -v "$PWD":/dynamodb_local_db -p 8000:8000 --network lambda-local --name dynamodb cnadiminti/dynamodb-local</code></p>

<p>Then write a test to exercise the system:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">exec</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">child_process</span><span class="dl">'</span><span class="p">).</span><span class="nx">exec</span>
<span class="kd">const</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">chai</span><span class="dl">'</span><span class="p">).</span><span class="nx">expect</span>

<span class="kd">const</span> <span class="nx">rootUrl</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">rootUrl</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">http://127.0.0.1:3000</span><span class="dl">'</span>
<span class="kd">const</span> <span class="nx">dynamoDbUrl</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">dynamoDbUrl</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">http://0.0.0.0:8000</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">countItemsInTable</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">exec</span><span class="p">(</span>
      <span class="s2">`aws dynamodb scan --table-name visitplannr-events --endpoint-url </span><span class="p">${</span><span class="nx">dynamoDbUrl</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdOut</span><span class="p">,</span> <span class="nx">stdErr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span>
          <span class="k">return</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">scanResult</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">stdOut</span><span class="p">)</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">scanResult</span><span class="p">.</span><span class="nx">Items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">propose destination</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">can write an event to dynamodb</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>

    <span class="nx">countItemsInTable</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">startCount</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">(</span><span class="nx">rootUrl</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/destination</span><span class="dl">'</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"name":"test destination","geolocation":{"x": 0, "y": 0}}</span><span class="dl">'</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
              <span class="k">return</span>
            <span class="p">}</span>
            <span class="nx">countItemsInTable</span><span class="p">()</span>
              <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">finalCount</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">finalCount</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">startCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nx">done</span><span class="p">()</span>
              <span class="p">})</span>
              <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
          <span class="p">})</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>


</code></pre></div></div>

<p>This is not a great example of a test for a number of reasons but it does demonstrate that the running system can receive an HTTP post after which there is one more item in the dynamodb table.
<!--alex ignore devil --->
The devil is always in the detail so this test wouldn't be good enough for a real system. But it does show that the lambda functions can be integration tested locally with real HTTP calls, writing to a local dynamodb.</p>

<h1 id="unit-testing">Unit testing</h1>

<p>The composition root approach means that the handler can be unit tested without relying on the dynamodb client. As an example testing the behaviour in the repository against a fake dynamodb, here the test locks in that the repository adds a correlation id to the item written to the stream:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">const</span> <span class="nx">streamRepoFactory</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../destinations/make-stream-repository</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">expect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">chai</span><span class="dl">'</span><span class="p">).</span><span class="nx">expect</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">the stream repository</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">fakeGuidGenerator</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">generate</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="dl">'</span><span class="s1">a-generated-guid</span><span class="dl">'</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">fakeDynamoDbClient</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">put</span><span class="p">:</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">callback</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">streamRepo</span> <span class="o">=</span> <span class="nx">streamRepoFactory</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="nx">fakeDynamoDbClient</span><span class="p">,</span> <span class="nx">fakeGuidGenerator</span><span class="p">)</span>

  <span class="kd">let</span> <span class="nx">writeToTheStream</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">writeToTheStream</span> <span class="o">=</span> <span class="nx">streamRepo</span><span class="p">.</span><span class="nx">writeToStream</span><span class="p">(</span>
      <span class="p">{</span>
        <span class="na">streamName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">arbitrary-string</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">event</span><span class="p">:</span> <span class="p">{</span><span class="na">winnie</span><span class="p">:</span> <span class="dl">'</span><span class="s1">pooh</span><span class="dl">'</span><span class="p">}</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">decorates the event with a correlation id</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">writeToTheStream</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">writtenItem</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">writtenItem</span><span class="p">.</span><span class="nx">Item</span><span class="p">.</span><span class="nx">event</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">equal</span><span class="p">({</span>
          <span class="na">winnie</span><span class="p">:</span> <span class="dl">'</span><span class="s1">pooh</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">correlationId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">a-generated-guid</span><span class="dl">'</span>
        <span class="p">})</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>

</code></pre></div></div>

<p>Writing to the event stream can be tested with a guid generator that always generates the same guid, and a dynamodb client that doesn't connect to dynamodb. This lets other behaviour be tested without those dependencies complicating or slowing down the tests.</p>

<h1 id="testing-in-aws">Testing in AWS</h1>

<p>The integration test above is bound to querying dynamodb using the AWS CLI. It would not take a lot of fixing to have that test run against an actual API Gateway endpoint and dynamodb instance.</p>

<p>At this point the code is still coming together but demonstrates that there is a local dev story, the system could be tested in CI, and can run in AWS.</p>

<h1 id="extending-the-system">Extending the system</h1>

<p>So now POSTing to Lambda can write events to dynamodb. In the next post we will look at subscribing to and responding to that event stream.</p>

<p>All the code for this stage can be found <a href="https://github.com/pauldambra/visit-plannr/tree/code-blog-post-part-three">on github</a></p>
:ET