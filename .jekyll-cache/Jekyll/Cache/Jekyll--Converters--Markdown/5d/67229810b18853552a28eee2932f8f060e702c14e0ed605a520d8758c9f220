I"|,<p>I've really been enjoying using Albacore Rake instead of MSBuild at work. It's enabled us to get everyone involved (because ugh, msbuild xml) and to improve our CI/CD pipeline.</p>

<p>Today we were talking about reducing the number of build configurations we have… which we only have in order to support config transforms.</p>

<!--more-->

<p>NB: this is all with Albacore Rake version one.</p>

<p>Here's a rakefile that will clean and build a .Net solution</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'albacore'</span>

<span class="no">SOLUTION_FILE</span> <span class="o">=</span> <span class="s2">"../SolutionName.sln"</span>
<span class="no">BUILD_CONFIG</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'Configuration'</span><span class="p">]</span> <span class="o">||</span> <span class="s2">"Release"</span>

<span class="no">MSBUILD_PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:configuration</span> <span class="o">=&gt;</span> <span class="no">BUILD_CONFIG</span><span class="p">,</span>
  <span class="ss">:VisualStudioVersion</span> <span class="o">=&gt;</span> <span class="mf">12.0</span> <span class="c1"># or you have to edit csproj for this to work</span>
<span class="p">}</span>

<span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:build</span><span class="p">]</span>

<span class="n">msbuild</span> <span class="ss">:clean</span> <span class="k">do</span> <span class="o">|</span><span class="n">msb</span><span class="o">|</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">properties</span> <span class="o">=</span> <span class="no">MSBUILD_PROPERTIES</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">targets</span> <span class="ss">:Clean</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">solution</span> <span class="o">=</span> <span class="no">SOLUTION_FILE</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">verbosity</span> <span class="o">=</span> <span class="ss">:normal</span>
<span class="k">end</span>

<span class="n">msbuild</span> <span class="ss">:build</span><span class="o">=&gt;</span><span class="p">[</span><span class="ss">:clean</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">msb</span><span class="o">|</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">properties</span> <span class="o">=</span> <span class="no">MSBUILD_PROPERTIES</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">targets</span> <span class="ss">:Build</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">solution</span> <span class="o">=</span> <span class="no">SOLUTION_FILE</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">verbosity</span> <span class="o">=</span> <span class="ss">:normal</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this scenario I want to replace the value of an app setting key. The section in the web.config in question:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;appSettings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"TheSetting"</span> <span class="na">value=</span><span class="s">"value that needs to change"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/appSettings&gt;</span>
</code></pre></div></div>

<h3 id="aside-dont-always-do-this">aside: don't always do this!</h3>

<p>The web.config transform to replace one or two values is pretty straightforward so if you don't have many different configurations or many things to change then you can probably stick with that.</p>

<p>But if you want to be able to apply the transform outside of packaging/deploying or if things are getting gnarly then I definitely recommend exploring <a href="https://github.com/Albacore/albacore">albacore</a></p>

<h1 id="a-template-webconfig">A template web.config</h1>
<p>I keep rake files in a folder at the root of the solution named Build (but they don't have to be there). And so I added a folder named templates to that. Then added a copy of the web.config to that folder.</p>

<p>This annoys and worries me as it will need to be kept in sync as the web.config changes (say someone adds a Nuget package to the project that alters the web.config). And so this feels like a potential source of error. But…</p>

<p>In this file any value that needs changing can be replaced with a <a href="http://blog.revathskumar.com/2013/01/ruby-multiple-string-substitution-in-string-template.html">ruby string interpolation format placeholder thingy</a> (hmmm, did I give away that I don't ruby programming language much?)</p>

<p>So…</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;appSettings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"TheSetting"</span> <span class="na">value=</span><span class="s">"%{the_setting}"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/appSettings&gt;</span>
</code></pre></div></div>

<h1 id="yaml">YAML</h1>

<p>YAML or YAML Ain't Markup Language is a <a href="http://www.yaml.org/">"human friendly data serialization
  standard for all programming languages."</a>. There's more to learn about <a href="http://yaml4r.sourceforge.net/doc/">yaml in ruby here</a></p>

<p>For each build config add a yaml file. In this example case I added a release.yaml file to the Build/templates folder:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">:the_setting: altered-value</span>
</code></pre></div></div>

<p>Complex, right? Wrong! If anything there's too little text in here for my tastes (although I'm unfamiliar with yaml so it may be because of the effort I have to expend to parse it)</p>

<p>The important thing here is that the yaml key begins with a colon to support the string replacement method used below.</p>

<h1 id="the-rake-task">The rake task</h1>

<p>The rakefile should look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'albacore'</span>
<span class="nb">require</span> <span class="s1">'yaml'</span>

<span class="no">SOLUTION_FILE</span> <span class="o">=</span> <span class="s2">"../SolutionName.sln"</span>
<span class="no">BUILD_CONFIG</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'Configuration'</span><span class="p">]</span> <span class="o">||</span> <span class="s2">"Release"</span>
<span class="no">WEBCONFIG_PATH</span> <span class="o">=</span> <span class="s2">"../ProjectName/Web.config"</span>

<span class="no">MSBUILD_PROPERTIES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:configuration</span> <span class="o">=&gt;</span> <span class="no">BUILD_CONFIG</span><span class="p">,</span>
  <span class="ss">:VisualStudioVersion</span> <span class="o">=&gt;</span> <span class="mf">12.0</span>
<span class="p">}</span>

<span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:build</span><span class="p">]</span>

<span class="n">msbuild</span> <span class="ss">:clean</span> <span class="k">do</span> <span class="o">|</span><span class="n">msb</span><span class="o">|</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">properties</span> <span class="o">=</span> <span class="no">MSBUILD_PROPERTIES</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">targets</span> <span class="ss">:Clean</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">solution</span> <span class="o">=</span> <span class="no">SOLUTION_FILE</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">verbosity</span> <span class="o">=</span> <span class="ss">:normal</span>
<span class="k">end</span>

<span class="n">msbuild</span> <span class="ss">:build</span><span class="o">=&gt;</span><span class="p">[</span><span class="ss">:clean</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">msb</span><span class="o">|</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">properties</span> <span class="o">=</span> <span class="no">MSBUILD_PROPERTIES</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">targets</span> <span class="ss">:Build</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">solution</span> <span class="o">=</span> <span class="no">SOLUTION_FILE</span>
    <span class="n">msb</span><span class="p">.</span><span class="nf">verbosity</span> <span class="o">=</span> <span class="ss">:normal</span>
<span class="k">end</span>

<span class="n">task</span> <span class="ss">:transform_config</span> <span class="k">do</span> 
  <span class="n">configHash</span> <span class="o">=</span> <span class="no">YAML</span><span class="p">.</span><span class="nf">load_file</span><span class="p">(</span><span class="s2">"templates/</span><span class="si">#{</span><span class="no">BUILD_CONFIG</span><span class="si">}</span><span class="s2">.yaml"</span><span class="p">)</span>
  <span class="n">templateConfig</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"templates/web.config"</span><span class="p">)</span> 
  <span class="n">newConfig</span> <span class="o">=</span> <span class="n">templateConfig</span> <span class="o">%</span> <span class="n">configHash</span>
  <span class="no">File</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="no">WEBCONFIG_PATH</span><span class="p">,</span> <span class="n">newConfig</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This file has a new task which loads the settings from the yaml file into a hash. And then loads the contents of the web.config template as a string.</p>

<p>It then uses the <code class="language-plaintext highlighter-rouge">string % hash</code> method of string interpolation that has been available since Ruby 1.9.2</p>

<p>This mechanism requires that the hash keys are symbols and not strings which is why the keys in the yaml file have to begin with a colon.</p>

<h1 id="does-this-solve-my-problems">Does this solve my problems?</h1>

<p>More config yaml files can be added. Whole sections can be excluded from configs by being replaced with empty strings. And more importantly the project and solution files don't need to know about these configurations to support different values in different deployments.</p>

<p>There might be pain points here I haven't discovered in this example but I like what I see so far!</p>

:ET